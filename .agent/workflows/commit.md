---
description: コミットメッセージの規約とコミット単位のルール
---

# /commit — コミットルール

## コミットメッセージ規約（Conventional Commits）

### prefix 一覧

| prefix | 使いどころ | 例 |
|---|---|---|
| `feat:` | 新しい機能を追加したとき | `feat: /api/events をFirestore保存に対応` |
| `fix:` | 既存の不具合を直したとき | `fix: step_answered の許可値漏れを修正` |
| `refactor:` | 機能変更なしのコード改善 | `refactor: ALLOWED_VALUES を辞書構造に変更` |
| `docs:` | ドキュメントのみの変更 | `docs: README にデプロイ手順を追加` |
| `chore:` | ビルド・設定・依存関係 | `chore: express-rate-limit を 7.x に更新` |
| `test:` | テストの追加・修正のみ | `test: events API の許可値テストを追加` |
| `style:` | フォーマット・空白のみ | `style: server.js のインデント修正` |

### メッセージ構造

```
<prefix>: <1行で「何を良くしたか」>

<任意: 詳細説明（なぜ・どう変えたか）>
<任意: 箇条書きで補足>
```

**1行目（件名）のルール:**
- 50文字以内を目安（日本語の場合はもう少し長くてOK）
- 末尾にピリオドを付けない
- 命令形 or 体言止め（「修正した」ではなく「修正」）

**本文のルール（任意）:**
- 件名と本文の間は空行1行
- 複数の変更点は `-` の箇条書き
- `fix:` / `feat:` が混在する場合は主たる方を件名に、もう一方を本文に記載

```
fix: ALLOWED_VALUES が app.js実装と不一致でデータがドロップされていた

feat: stepIdごとの許可値辞書(ALLOWED_VALUES_BY_STEP)に変更
- 旧値15種を削除 (children/elderly/yes/no 等)
- テスト38件追加 (許可値保存27 + 拒否値破棄9 + フォールバック2)
```

---

## コミット単位の原則

### ✅ 守ること

1. **中途半端な状態はコミットしない**
   - ビルド壊れ・テスト落ち・途中コードのままは、後で自分も他人も困る
   - 「このコミットだけ戻しても安全」な単位で切るのが理想

2. **1コミット = 1つの意図**
   - 機能追加とバグ修正が混在したら、可能な限り分ける
   - ただし「バグ修正 + そのテスト追加」はセットで1コミットでOK

3. **テストとコードは同じコミットに入れる**
   - コードだけ先にコミットしてテスト後付けはNG（テストなしの状態がhistoryに残る）

### ⚠️ WIP（どうしても途中保存したい時）

```
WIP: events validation refactor (tests not updated yet)
```

- これは「未完成です」のサイン
- レビュー前に仕上げコミットを足す or squash する
- WIPのまま push は原則しない（ローカル限定）

---

## 実務のコツ

> **迷ったら「このコミットは何を良くした？」を1文で言えるかで判断。**
> 言えないなら、まだ分割した方がいい。

### 判断フロー

```
コミットしようとしている変更
  ├─ 1文で説明できる？ → ✅ コミットする
  ├─ 2つ以上の話題が混ざってる？ → 🔀 分割を検討
  ├─ テスト通ってない？ → ❌ まだコミットしない
  └─ どうしても保存したい？ → ⚠️ WIP: をつけてローカルのみ
```

---

## エージェント向け手順

// turbo-all

1. `git diff --cached --stat` で変更ファイルを確認（未ステージなら `git add -A` を先に実行）
2. 変更内容を分析し、上記の prefix ルールに従ってメッセージを生成
3. 複数の性質が混在する場合は、主たるものを件名 prefix に、他は本文に記載
4. テストが存在する場合は `npm test` を実行して PASS を確認してからコミット
5. コミット実行

```powershell
git commit -m "<prefix>: <件名>" -m "<本文（任意）>"
```

6. ローカルサーバーを再起動（既に起動中の場合は停止してから起動）

```powershell
npm run dev
```
