---
description: コード変更後に関連ファイルへの影響を自動チェックする
---

# /impact-check — 変更影響チェックワークフロー

## 概要
コードを変更した後、変更箇所を起点に **関連する呼び出し元・DOM構造・状態管理** への影響を自動で洗い出し、見落としを防ぐ。

## トリガー
- ユーザーから修正依頼を受けてコードを変更した後、**自動的に実行する**
- 明示的に `/impact-check` と呼ばれた場合

---

## ステップ

### 1. 変更の棚卸し
変更したファイル・関数を一覧にする。

// turbo
```
view_file_outline で変更ファイルの構造を取得
```

出力：
```
| ファイル | 変更関数/セレクタ | 変更内容（1行要約） |
```

### 2. 呼び出し元の洗い出し（静的トレース）
変更した各関数・CSSクラス・DOM ID について、**プロジェクト全体から参照箇所を検索**する。

// turbo
チェック対象：
- `grep_search` で関数名・クラス名・ID名を検索
- `app.js`, `index.html`, `style.css`, `server.js`, `audit-routes.js` を対象

出力：
```
| 変更した要素 | 参照元（ファイル:行） | 影響の有無 | 理由 |
```

### 3. DOM操作の親子関係チェック
変更に DOM操作（`appendChild`, `innerHTML`, `querySelector`, `getElementById` 等）が含まれる場合、以下を検証：

- [ ] **追加先が正しい親要素か**: `el` vs `el.parentElement` — 表示/非表示の切替と連動するか
- [ ] **innerHTML で上書きする際の巻き込み**: 他の子要素が消えないか
- [ ] **クエリの検索スコープ**: `document.querySelector` vs `el.querySelector` — 意図した範囲に限定されているか
- [ ] **イベントハンドラの生存**: innerHTML 上書き後にイベントリスナーが失われないか

### 4. 状態管理の整合性チェック
`state` オブジェクトを変更する箇所がある場合：

- [ ] **書き込み箇所**: どの関数が `state.xxx` を更新するか
- [ ] **読み取り箇所**: その値を参照している関数はどれか（特に `exportPDF` 等の出力系）
- [ ] **ライフサイクル**: 値がセットされる前に参照されるパスがないか

### 5. CSS影響チェック
CSSクラスを追加・変更した場合：

- [ ] **同名クラスの他箇所での使用**: 意図しない要素にスタイルが適用されないか
- [ ] **レスポンシブ対応**: `@media` クエリ内に対応するスタイルが必要か
- [ ] **z-index / position**: オーバーレイや固定要素との重なりが発生しないか

### 6. 判定の出力

```
## 影響チェック結果

| # | チェック項目 | 結果 | 詳細 |
|---|------------|------|------|
| 1 | 呼び出し元の整合性 | ✅/⚠️ | ... |
| 2 | DOM親子関係 | ✅/⚠️ | ... |
| 3 | 状態管理の整合性 | ✅/⚠️ | ... |
| 4 | CSS影響 | ✅/⚠️ | ... |

### 結論
✅ 影響なし — このまま進めてOK
⚠️ 要修正 — 以下の箇所を修正してください：（リスト）
```

---

## 補足ルール

- **⚠️が1つでもあれば、修正を提案**してからユーザーに報告する
- チェック結果はチャット内で直接報告（アーティファクト不要）
- このワークフローは `/review`（品質レビュー）とは独立。`/review` は品質、`/impact-check` は安全性
